#!/bin/bash -e

export PATH=/var/vcap/packages/uaa/jdk/bin:$PATH

# Proxy configuration
HTTP_PROXY_JAVA_OPTIONS=""

<% if_p('env.http_proxy') do |httpProxy| %>
export HTTP_PROXY='<%= httpProxy %>'
export http_proxy='<%= httpProxy %>'
proxy_conf=(`echo $HTTP_PROXY | tr ":" " " | tr "\/" " "`)
HTTP_PROXY_JAVA_OPTIONS="$HTTP_PROXY_JAVA_OPTIONS -Dhttp.proxyHost=${proxy_conf[1]} -Dhttp.proxyPort=${proxy_conf[2]} "
<% end %>

<% if_p('env.https_proxy') do |httpsProxy| %>
export HTTPS_PROXY='<%= httpsProxy %>'
export https_proxy='<%= httpsProxy %>'
proxy_conf=(`echo $HTTPS_PROXY | tr ":" " " | tr "\/" " "`)
HTTP_PROXY_JAVA_OPTIONS="$HTTP_PROXY_JAVA_OPTIONS -Dhttps.proxyHost=${proxy_conf[1]} -Dhttps.proxyPort=${proxy_conf[2]} "
<% end %>

<% if_p('env.no_proxy') do |noProxy| %>
export NO_PROXY='<%= noProxy %>'
export no_proxy='<%= noProxy %>'
if [ x != x"$NO_PROXY" ]; then
  proxy_conf=`echo $NO_PROXY | sed -e 's/ //g'`

  OIFS=$IFS
  IFS=','
  for host in $proxy_conf; do
      if [[ $host == .* ]]; then
        host="*"$host
      fi
      java_no_proxies=$java_no_proxies"|"$host
  done
  IFS=$OIFS

  # Strip the leading '|'
  java_no_proxies=${java_no_proxies:1}
  HTTP_PROXY_JAVA_OPTIONS="$HTTP_PROXY_JAVA_OPTIONS -Dhttp.nonProxyHosts=\"$java_no_proxies\" "
fi
<% end %>

NEWRELIC_OPTS=
<% if_p('uaa.newrelic') do |newrelic|
    newrelicenv = newrelic['environment'] || 'production'

    hasnewreliclic = p('uaa.newrelic.common.license_key', nil) || p('uaa.newrelic.'+newrelicenv+'.license_key', '').to_s.strip.length > 0

    if hasnewreliclic %>
          <%= "NEWRELIC_OPTS=\"-javaagent:/var/vcap/jobs/uaa/tomcat/bin/newrelic.jar -Dnewrelic.config.file=$JOB_DIR/config/newrelic.yml -Dnewrelic.environment="+newrelicenv+"\"" %><%
    end
end %>

export NEWRELIC_OPTS

set +e

touch $STATUS

<% if p('uaa.ldap.sslCertificate', nil) || p('login.ldap.sslCertificate', nil) %>
/var/vcap/jobs/uaa/bin/install_crt ldap.crt ldapcert $KEYSTORE
<% end %>

export JAVA_OPTS="-DPID=$$ -Dsun.net.inetaddr.ttl=60 -Dnetworkaddress.cache.ttl=60 $HTTP_PROXY_JAVA_OPTIONS $UAA_OPTIONS $NEWRELIC_OPTS $KEYSTORE_OPTS"

# Install the server's ssl certificate
<% if p("uaa.ssl.port") != -1 %>
/var/vcap/jobs/uaa/bin/install_uaa_crt uaa.crt
<% end %>

cd /var/vcap/packages/uaa
exec tomcat/bin/catalina.sh run
